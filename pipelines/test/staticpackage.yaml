name: staticpackage

# static packages that contain only static libraries, which are linked into applications at compile time rather than at runtime.
# this packages only contains `.a` files, no other files are expected. this pipeline checks that the package contains only static libraries.
pipeline:
  - name: static package check
    runs: |
      # Get our static package name, which is usually a sub package
      static_pkg=$(basename ${{targets.contextdir}})
      static_files=0

      # Test static library files
      for static_file in $(apk info -qL "$static_pkg" | grep -v "^var/lib/db/sbom"); do
        if [ -f /"$static_file" ]; then
          case "$static_file" in
            *.a)
              static_files=$((static_files + 1))
              ;;
            *)
              # Any other file type is not expected in a static-only package
              echo "FAIL: Package [$static_pkg] contains non-static file: $static_file"
              echo "      Expected only .a files and .spdx.json metadata"
              echo ""
              exit 1
              ;;
          esac
        fi
      done

      if [ $static_files -eq 0 ]; then
        echo "See:"
        apk info -qL "$static_pkg"
        echo "FAIL: This package [$static_pkg] do not contain usable static libraries"
        echo "      Please check the package build for proper static library installation, and either:"
        echo "        (a) fix the static subpackage build to actually include .a files (check the split/static pipeline), or"
        echo "        (b) remove the test/staticpackage pipeline"
        exit 1
      fi

      echo "PASS: Package [$static_pkg] contains only valid static libraries, total static files: $static_files"
